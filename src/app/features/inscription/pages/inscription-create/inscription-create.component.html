<div class="inscription-container">
  <!-- Formulaire -->
  <div id="inscription_container_form">
    <form id="inscription_form" [formGroup]="inscriptionCreationForm" (ngSubmit)="handleInscription()">
      <div formGroupName="user" id="inscription_user_datas_form">
        <!-- Informations personnelles -->
        <section id="infos_persos" class="form-section">
          <h1>Formulaire d'inscription</h1>

          <label>Informations personnelles</label>

          <!-- <label for="firstName">Prénom*</label> -->
          <input id="firstName" formControlName="firstName" type="text" placeholder="Prénom" />

          <!-- <label for="lastName">Nom*</label> -->
          <input id="lastName" formControlName="lastName" type="text" placeholder="Nom" />

          <!-- <label for="lastName">Nom*</label> -->
          <input id="otherNames" formControlName="otherNames" type="text" placeholder="Autres noms" />

          <p-datepicker
            [showIcon]="false"
            [showButtonBar]="true"
            [readonlyInput]="true"
            dateFormat="dd/mm/yy"
            id="birthdate"
            formControlName="birthdate"
            placeholder="Date de naissance"
          ></p-datepicker>
          <!-- <label for="birthplace">Lieu de naissance*</label> -->
          <input id="birthplace" formControlName="birthplace" type="text" placeholder="Lieu de naissance" />
        </section>

        <!-- Adresse -->
        <section class="form-section">
          <!-- <h3>Adresse</h3> -->

          <!-- <label for="streetAndNumber">Rue et numéro*</label> -->
          <input id="streetAndNumber" formControlName="streetAndNumber" type="text" placeholder="Rue et numéro" />

          <!-- <label for="zipCode">Code Postal*</label> -->
          <input id="zipCode" formControlName="zipCode" type="number" placeholder="Code postal" />

          <!-- <label for="city">Ville*</label> -->
          <input id="city" formControlName="city" type="text" placeholder="Ville" />
        </section>

        <!-- Contact -->
        <section class="form-section">
          <!-- <h3>Contact</h3> -->

          <!-- <label for="telephone">Téléphone*</label> -->
          <input id="telephone" formControlName="telephone" type="tel" placeholder="Téléphone" />

          <!-- <label for="email">Email*</label> -->
          <input id="email" formControlName="email" type="email" placeholder="Email" />
        </section>

        <!-- Mot de passe -->
        <section class="form-section">
          <!-- <label for="password">Mot de passe*</label> -->
          <input id="password" type="password" placeholder="Mot de passe (accès à votre espace client)" formControlName="password" />
          <div *ngIf="inscriptionCreationForm.get('password')?.invalid && inscriptionCreationForm.get('password')?.touched" class="error-message">
            <span *ngIf="inscriptionCreationForm.get('password')?.errors?.['required']">Le mot de passe est requis.</span>
            <span *ngIf="inscriptionCreationForm.get('password')?.errors?.['minlength']">Minimum 6 caractères.</span>
          </div>
        </section>
      </div>
      <br/>
      <br>
      <!-- Type de stage -->
      <section class="form-section" id="inscription_stage_type_section">
        <label id="label_stage_type">Type de stage*</label>

        <div class="radio-group">
          <!-- Stage volontaire -->
          <div class="radio-option"
               [class.selected]="stageTypeControl!.value === 'VOLONTAIRE'"
               (click)="selectStageType('VOLONTAIRE')">
            <input
              type="radio"
              id="volontaire"
              name="stageType"
              value="VOLONTAIRE"
              formControlName="stageType">
            <div class="radio-custom"></div>
            <label class="radio-label" for="volontaire">Stage volontaire</label>
          </div>

          <!-- Stage obligatoire permis probatoire -->
          <div class="radio-option"
               [class.selected]="stageTypeControl!.value === 'OBLIGATOIRE'"
               (click)="selectStageType('OBLIGATOIRE')">
            <input
              type="radio"
              id="obligatoire-permis"
              name="stageType"
              value="OBLIGATOIRE"
              formControlName="stageType">
            <div class="radio-custom"></div>
            <label class="radio-label" for="obligatoire-permis">Stage obligatoire permis probatoire</label>
          </div>

          <!-- Stage obligatoire imposé par le Tribunal -->
          <div class="radio-option"
               [class.selected]="stageTypeControl!.value === 'TRIBUNAL'"
               (click)="selectStageType('TRIBUNAL')">
            <input
              type="radio"
              id="obligatoire-tribunal"
              name="stageType"
              value="TRIBUNAL"
              formControlName="stageType">
            <div class="radio-custom"></div>
            <label class="radio-label" for="obligatoire-tribunal">Stage obligatoire imposé par le Tribunal</label>
          </div>
        </div>
      </section>

      <div class="cards-container">
        <div
          *ngFor="let card of cards; let i = index"
          [class]="getCardClasses(card)"
          [attr.data-type]="card.type">

          <!-- Upload PrimeNG caché avec design personnalisé -->
          <div class="custom-upload-wrapper" *ngIf="!card.disabled">
            <p-fileUpload
              #fileUpload
              [url]="uploadUrl"
              [accept]="acceptedTypes"
              [maxFileSize]="maxFileSize"
              [auto]="false"
              [multiple]="false"
              [customUpload]="true"
              [showUploadButton]="false"
              [showCancelButton]="false"
              [chooseLabel]="''"
              [chooseIcon]="''"
              (onSelect)="onFileSelected($event, card)"
              (onRemove)="onFileRemoved($event, card)"
              (uploadHandler)="uPloadFiles($event,card)"
              class="custom-file-upload">

              <!-- Template personnalisé pour le contenu -->
              <ng-template pTemplate="content">
                <div class="upload-content" (click)="triggerFileSelect(i)">
                  <div class="card-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                  </div>

                  <h3 class="card-title">{{ card.title }}</h3>
                  <p class="card-subtitle">{{ card.subtitle }}</p>

                  <div [class]="getStatusClasses(card)" *ngIf="card.status">
                    {{ card.status }}
                  </div>

                  <!-- Aperçu du fichier sélectionné -->
                  <div class="file-preview" *ngIf="card.file && !card.isUploaded">
                    <div class="file-info">
                      <i class="pi pi-file"></i>
                      <span class="file-name">{{ card.file.name }}</span>
                      <button
                        type="button"
                        class="remove-file-btn"
                        (click)="removeFile(card, $event)">
                        <i class="pi pi-times"></i>
                      </button>
                    </div>

                    <button
                      type="button"
                      class="upload-btn"
                      (click)="startUpload(card, $event)"
                      [disabled]="card.isUploading">
                    <span *ngIf="!card.isUploading">
                      <i class="pi pi-upload"></i> Uploader
                    </span>
                      <span *ngIf="card.isUploading">
                      <i class="pi pi-spin pi-spinner"></i> Upload...
                    </span>
                    </button>
                  </div>
                </div>
              </ng-template>

              <!-- Template vide pour masquer l'interface par défaut -->
              <ng-template pTemplate="toolbar">
                <div></div>
              </ng-template>
            </p-fileUpload>
          </div>

          <!-- Carte désactivée -->
          <div class="disabled-content" *ngIf="card.disabled">
            <div class="card-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
              </svg>
            </div>

            <h3 class="card-title">{{ card.title }}</h3>
            <p class="card-subtitle">{{ card.subtitle }}</p>

            <div class="upload-status show">
              Non disponible
            </div>
          </div>
        </div>
      </div>

      <p-toast></p-toast>


      <!--
            <section id="inscription_form_files" class="form-section">
              <h3>Documents à fournir<br>(<small>Si le permis vous a été retiré, veuillez nous envoyer l'avis de suspension</small>)
              </h3>

              <div class="file-upload-section">
                <p-fileUpload
                  name="Permis de conduire"
                  [customUpload]="true"
                  (uploadHandler)="uploadFiles($event)"
                  (onSelect)="onFilesChange($event, 'permis')"
                  (onRemove)="onRemoveFile($event, 'permis')"
                  [multiple]="true"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  accept=".pdf,image/*"
                  chooseLabel=" Permis de conduire"
                  mode="advanced"
                  [maxFileSize]="5000000"
                  id="driving_license"
                ><ng-template pTemplate="content">
                  <div class="upload-box" (click)="triggerFileSelect(i)">
                    <div class="upload-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6h.1a5 5 0 011 9.9M9 19l3 3 3-3M12 22V10"
                              stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <div class="upload-text">
                      {{ card.title || 'Parcourir les fichiers' }}
                    </div>
                  </div>

                  &lt;!&ndash; input caché &ndash;&gt;
                  <input type="file" #fileInput hidden (change)="handleFile($event, i)">
                </ng-template>


                </p-fileUpload>
              </div>

              <div class="file-upload-section">
                <p-fileUpload
                  name="Carte d'identité"
                  [customUpload]="true"
                  (uploadHandler)="uploadFiles($event)"
                  (onSelect)="onFilesChange($event, 'carteId')"
                  (onRemove)="onRemoveFile($event, 'carteId')"
                  [multiple]="true"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  accept=".pdf,image/*"
                  chooseLabel=" Carte d'identité"
                  mode="advanced"
                  [maxFileSize]="5000000"
                  id="carteId"
                ></p-fileUpload>
              </div>

              <div *ngIf="selectedStageLabel === 'Stage obligatoire permis probatoire'" class="file-upload-section">
                <p-fileUpload
                  name="lettre48n"
                  [customUpload]="true"
                  (uploadHandler)="uploadFiles($event)"
                  (onSelect)="onFilesChange($event, 'lettre48n')"
                  (onRemove)="onRemoveFile($event, 'lettre48n')"
                  [multiple]="true"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  accept=".pdf,image/*"
                  chooseLabel=" Lettre 48N"
                  mode="advanced"
                  [maxFileSize]="5000000"
                  id="lettre48"
                ></p-fileUpload>
              </div>
              <div *ngIf="selectedStageLabel === 'Stage obligatoire imposé par le tribunal'" class="file-upload-section">
                <p-fileUpload
                  name="Décision de justice"
                  [customUpload]="true"
                  (uploadHandler)="uploadFiles($event)"
                  (onSelect)="onFilesChange($event, 'decisionJustice')"
                  (onRemove)="onRemoveFile($event, 'décision de justice')"
                  [multiple]="true"
                  [showUploadButton]="false"
                  [showCancelButton]="false"
                  accept=".pdf,image/*"
                  chooseLabel=" Décision de justice"
                  mode="advanced"
                  [maxFileSize]="5000000"
                  id="court_letter"
                ></p-fileUpload>
              </div>
            </section>-->

      <!-- Code promo -->
      <section class="form-section">
        <!-- <label for="codePromo">Code Promo (optionnel)</label> -->
        <input id="codePromo" formControlName="codePromo" placeholder="Code Promo" />
      </section>

      <!-- Erreurs -->
      <div *ngIf="lettre48nError" class="error-message">
        {{ lettre48nError }}
      </div>
      <!-- RGPD -->
      <div class="checkbox_register">
        <input id="acceptTerms" type="checkbox" formControlName="acceptTerms" />
        <p>
          Acceptez nos
          <a href="#" (click)="goToConditions($event)" style="text-decoration: underline;">
            Conditions d'utilisation et notre Politique de confidentialité
          </a>
        </p>
      </div>

      <div *ngIf="inscriptionCreationForm.get('acceptTerms')?.invalid && inscriptionCreationForm.get('acceptTerms')?.touched" class="error-message">
        Acceptez nos Conditions d'utilisation et notre Politique de confidentialité
      </div>

      <!-- Soumission -->
      <div class="submit-wrapper">
        <button type="submit" [disabled]="inscriptionCreationForm.invalid || isLoading" class="submit-button">
          <ng-container *ngIf="isLoading">
            <span class="spinner-inline"></span> Chargement...
          </ng-container>
          <ng-container *ngIf="!isLoading">
            Valider l'inscription
          </ng-container>
        </button>
      </div>
    </form>
    <!-- Détails du stage -->
    <div id="inscription_container_details" class="stage-details" *ngIf="stageDetails">
      <div class="details-wrapper">
        <h1>Résumé</h1>
        <p>Stage agréé par la préfecture sous le numéro<br/>
          {{ stageDetails.number }}</p>
        <p>Nombre de points réccupérables à l’issue du
          stage :<span style="font-weight:900;"><strong>4 points</strong></span></p>
        <br>
        <hr>
        <br>
        <p>Lieu: {{ stageDetails.street }}, {{ stageDetails.city }}</p>
        <p><strong>Date: {{ stageDetails.dateDebut | date:'d':'fr' }} & {{ stageDetails.dateFin | date:'d MMMM yyyy':'fr' }}</strong></p>
        <p><strong>Horaire: {{ stageDetails.organisation}}</strong></p>

        <h1 style="margin-top:30%;">
          <strong> {{ stageDetails.price }}€</strong>
        </h1>
      </div>
    </div>
  </div>
</div>



